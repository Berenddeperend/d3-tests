<html>
<head>
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://d3js.org/d3-shape.v1.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>


<!-- <script src="https://d3js.org/d3.v5.js"></script> -->

<style>

	rect {
		border: 1px solid red;
		transition: opacity 0.5s;
		opacity: 1;
	}	

	.blurred {
		opacity: 0.5;
	}
</style>
</head>
<body>
<svg id="svg"></svg>

<button onclick="addDataPoint()">+</button>
<script>

console.log(d3)

const margin = {top: 20, right: 160, bottom: 35, left: 30};
const width = 960 - margin.left - margin.right;
const height = 300 - margin.top - margin.bottom;

const data2 = [
	{
		month: "januari",
		setup: 20,
		monthly: 43,
		usage: 30,
	},
	{
		month: "februari",
		setup: 2,
		monthly: 3,
		usage: 9,
	},
	{
		month: "maart",
		setup: 14,
		monthly: 33,
		usage: 2,
	},
	{
		month: "april",
		setup: 29,
		monthly: 3,
		usage: 32,
	}
]

const calcY = d3.scaleLinear()
	.domain([0, d3.max(data2.map(d => { //add every property except for 'month'
		return Object
			.keys(d)
			.filter(key => key !== 'month')
			.reduce((acc, curr) => {
				acc += d[curr]
				return acc;
			}, 0);
	}))])
	.range([0, height])

const calcX = d3.scaleBand()
	.domain(data2.map(d => d.month))
	.range([0, width])
	.padding(.05);

const stack = d3 //works
	.stack()
	.keys(Object.keys(data2[0]).filter(key => key !== 'month'))
	.order(d3.stackOrderNone)
	.offset(d3.stackOffsetNone);

const colors = [
	'rgba(16, 32, 88, 1)',
	'rgba(63, 150, 130, 1)',
	'rgba(224, 224, 224, 1)',
];

const svg = d3
	.select("#svg")
	.attr("height", height)
	.attr("width", width)

function handleMouseOver(d, i) {
	const index = [...this.parentNode.children].indexOf(this);
	svg.selectAll(`g.cost rect:not(:nth-child(${index + 1}))`).classed("blurred", true)
}

function handleMouseOut(d, i) {
	svg.selectAll("g.cost rect").classed("blurred", false)
}

function render() {
	const series = stack(data2);
	console.log('series: ', series);

	const groups = svg.selectAll("g.cost")
	.data(series)
	.join("g")
	.attr("class", 'cost')
	.attr("fill", (d,i) => { return colors[i]})

	console.log('groups', groups);

	const rect = groups.selectAll("rect")
		.data(d => d)
		.join("rect")
		.attr("height", d => calcY(d[1] - d[0]))
		// .attr("width", calcX.bandwidth())
		.attr("width", width / data2.length - 10)
		.attr("x", function(d, i) { return i * width / data2.length; })
		.attr("y", d => height - calcY(d[1]))
		.attr("opacity", 1)
		.on("mouseover", handleMouseOver)
		.on("mouseout", handleMouseOut);

	console.log('rect: ', rect);
}

render();

function addDataPoint() {
	data2.push({
		month: "nog een maand",
		setup: Math.floor(Math.random() * 40),
		monthly: Math.floor(Math.random() * 40),
		usage: Math.floor(Math.random() * 40),
	})

	render();
}

  
</script>

</body>
</html>
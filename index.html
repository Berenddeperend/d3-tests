<html>
<head>
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://d3js.org/d3-shape.v1.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>
<script src="https://d3js.org/d3-axis.v1.min.js"></script>



<!-- <script src="https://d3js.org/d3.v5.js"></script> -->

<style>

	svg {
		box-shadow: inset 0px 0px 0 10px red;
		border: 1px solid black
	}


	rect {
		transition: opacity 0.2s;
		opacity: 1;
	}	

	.hover, .active {
		opacity: 1 !important;
	}

	.blurred, .stay-blurred {
		opacity: 0.5;
	}
</style>
</head>
<body>
<svg id="svg"></svg>

<button onclick="addDataPoint()">+</button>
<script>


const margin = {top: 10, right: 10, bottom: 10, left: 10};
const width = 500
const height = 300

const data2 = [
	{
		month: "januari",
		setup: 20,
		monthly: 43,
		usage: 30,
	},
	{
		month: "februari",
		setup: 2,
		monthly: 3,
		usage: 9,
	},
	{
		month: "maart",
		setup: 14,
		monthly: 33,
		usage: 2,
	},
	{
		month: "april",
		setup: 29,
		monthly: 3,
		usage: 32,
	}
]

const stack = d3 //works
	.stack()
	.keys(Object.keys(data2[0]).filter(key => key !== 'month'))
	.order(d3.stackOrderNone)
	.offset(d3.stackOffsetNone);

const colors = [
	'rgba(16, 32, 88, 1)',
	'rgba(63, 150, 130, 1)',
	'rgba(224, 224, 224, 1)',
];

const svg = d3
	.select("#svg")
	// .attr("viewBox", [0, 0, width, height]);
	.attr("height", height)
	.attr("width", width);

function handleMouseOver(d, i) {
	const index = [...this.parentNode.children].indexOf(this);
	svg.selectAll(`g.cost rect:nth-child(${index + 1})`).classed("hover", true)

	svg.selectAll(`g.cost rect:not(:nth-child(${index + 1}))`).classed("blurred", true)
}

function handleMouseClick(d, i) {
	const index = [...this.parentNode.children].indexOf(this);
	svg.selectAll("g.cost rect").classed("stay-blurred", false)
	svg.selectAll("g.cost rect").classed("active", false)
	svg.selectAll(`g.cost rect:nth-child(${index + 1})`).classed("active", true);
	svg.selectAll(`g.cost rect:not(:nth-child(${index + 1}))`).classed("stay-blurred", true)

}

function handleMouseOut(d, i) {
	const index = [...this.parentNode.children].indexOf(this);
	svg.selectAll("g.cost rect").classed("blurred", false)
	svg.selectAll("g.cost rect").classed("hover", false)
}

function render() {
	const series = stack(data2);

	const y = d3.scaleLinear()
	.domain([0, d3.max(data2.map(d => { //add every property except for 'month'
		return Object
			.keys(d)
			.filter(key => key !== 'month')
			.reduce((acc, curr) => {
				acc += d[curr]
				return acc;
			}, 0);
	}))])
	.range([0, height - margin.top - margin.bottom]);

	const x = d3.scaleBand()
	.domain(data2.map(d => d.month))
	.range([0, width])
	// .padding(.05);

	var xAxis = d3.axisBottom(x);

	svg.append("g")
		// .attr("transform", `translate(0, ${height - margin.bottom})`)
		.attr("transform", `translate(0, ${height})`)
		.call(xAxis)

	const groups = svg.selectAll("g.cost")
	.data(series)
	.join("g")
	.attr("class", 'cost')
	.attr("fill", (d,i) => { return colors[i]})


	const rect = groups.selectAll("rect")
		.data(d => d)
		.join("rect")
		.attr("height", d => y(d[1] - d[0]))
		// .attr("width", x.bandwidth())
		.attr("width", width / data2.length)
		// .attr("x", (d, i) => { return x(i) })
		.attr("x", function(d, i) { return i * width / data2.length; })
		.attr("y", d => height - y(d[1]) - margin.bottom)
		.attr("opacity", 1)
		.on("mouseover", handleMouseOver)
		.on("mouseout", handleMouseOut)
		.on("click", handleMouseClick)

}

render();

function addDataPoint() {
	data2.push({
		month: "nog een maand",
		setup: Math.floor(Math.random() * 50),
		monthly: Math.floor(Math.random() * 50),
		usage: Math.floor(Math.random() * 50),
	})

	render();
}

  
</script>

</body>
</html>